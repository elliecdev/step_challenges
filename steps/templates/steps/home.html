{% extends "steps/base.html" %}
{% block content %}

{% if current_challenge %}

<!-- 1ï¸âƒ£ HERO / CURRENT CHALLENGE -->
<section class="section pb-2">
  <div class="container is-max-desktop has-text-centered">
    <h1 class="title">
      ğŸš¶â€â™‚ï¸ {{ current_challenge.name }}
    </h1>

    <p class="is-size-6 has-text-grey mb-2">
      {{ current_challenge.start_date|date:"F j, Y" }}
      â€“
      {{ current_challenge.end_date|date:"F j, Y" }}
    </p>

    {% if current_challenge.is_active %}
      <div class="is-flex is-justify-content-center mb-3">
        <span class="tag is-medium mr-2">
          Day {{ days_elapsed }} / {{ total_days }}
        </span>

        {% if days_left == 0 %}
          <span class="tag is-danger is-light is-large">ğŸ‰ Final Day!</span>
        {% elif days_left <= 3 %}
          <span class="tag is-danger is-light is-medium pulse">
            ğŸ”¥ {{ days_left }} day{{ days_left|pluralize }} left
          </span>
        {% else %}
          <span class="tag is-info is-light is-medium">
            â³ {{ days_left }} day{{ days_left|pluralize }} remaining
          </span>
        {% endif %}
      </div>

      <progress
        class="progress is-primary is-small"
        value="{{ days_elapsed }}"
        max="{{ total_days }}">
      </progress>
    {% endif %}
  </div>
</section>

<!-- MAIN DASHBOARD -->
<section class="section pt-4">
  <div class="container is-max-desktop">

    <div class="columns is-multiline is-variable is-3">

      {# 2. YOUR STATUS CARD #}
      {% if user.is_authenticated and participant %}
      <div class="column is-12 is-4">
        <div class="box">
          <h2 class="title is-6">ğŸ™‹ You</h2>

          <div class="is-flex is-align-items-center mb-2">
            <span
              class="mr-2"
              style="width:10px;height:10px;border-radius:50%;background:{{ participant.team.color }};">
            </span>
            <strong>{{ participant.team.name }}</strong>
          </div>

          {% if latest_entry %}
            <p class="is-size-7 has-text-grey">
              Last entry: {{ latest_entry.total_steps }} steps<br>
              {{ latest_entry.date|date:"F j" }}
            </p>
          {% else %}
            <p class="is-size-7 has-text-grey">
              No steps logged yet
            </p>
          {% endif %}

          <a href="{% url 'steps-add-entry' %}"
             class="button is-primary is-small is-fullwidth mt-3">
            â• Add steps
          </a>
        </div>
      </div>
      {% endif %}

      {# 3. MINI LEADERBOARDS #}
      <div class="column is-12 is-8">
        <div class="columns is-variable is-3">

          <!-- Teams -->
          <div class="column">
            <div class="box">
              <h2 class="title is-6">ğŸ† Teams</h2>
              <ul>
                {% for team in top_teams %}
                  <li class="is-flex is-justify-content-space-between">
                    <span>
                      {% if forloop.counter == 1 %}ğŸ¥‡{% elif forloop.counter == 2 %}ğŸ¥ˆ{% elif forloop.counter == 3 %}ğŸ¥‰{% endif %}
                      {{ team.team__name }}
                    </span>
                    <strong>{{ team.total_steps }}</strong>
                  </li>
                {% endfor %}
              </ul>
              <a href="{% url 'steps-leaderboard' %}" class="is-size-7">
                View full leaderboard â†’
              </a>
            </div>
          </div>

          <!-- Participants -->
          <div class="column">
            <div class="box">
              <h2 class="title is-6">ğŸ§ Participants</h2>
              <ul>
                {% for p in top_participants %}
                  <li class="is-flex is-justify-content-space-between">
                    <span>
                      {% if forloop.counter == 1 %}ğŸ¥‡{% elif forloop.counter == 2 %}ğŸ¥ˆ{% elif forloop.counter == 3 %}ğŸ¥‰{% endif %}
                      {{ p.user.first_name|default:p.user.username }}
                    </span>
                    <strong>{{ p.total_steps }}</strong>
                  </li>
                {% endfor %}
              </ul>
            </div>
          </div>

        </div>
      </div>

      {# 4. QUICK STATS #}
      <div class="column is-12">
        <div class="box">
          <div class="columns has-text-centered">
            <div class="column">
              <p class="title is-5">{{ quick_stats.total_steps }}</p>
              <p class="is-size-7 has-text-grey">Total steps</p>
            </div>
            <div class="column">
              <p class="title is-5">{{ quick_stats.participants }}</p>
              <p class="is-size-7 has-text-grey">Participants</p>
            </div>
            <div class="column">
              <p class="title is-5">{{ quick_stats.avg_steps }}</p>
              <p class="is-size-7 has-text-grey">Avg / person</p>
            </div>
          </div>
        </div>
      </div>

      {# 5. RECENT ACTIVITY #}
      <div class="column is-12">
        <div class="box">
          <h2 class="title is-6">ğŸ•’ Recent activity</h2>
          <ul class="is-size-7">
            {% for entry in recent_entries %}
              <li>
                {{ entry.participant.user.first_name|default:entry.participant.user.username }}
                logged <strong>{{ entry.total_steps }}</strong> steps
                ({{ entry.date|date:"M j" }})
              </li>
            {% empty %}
              <li class="has-text-grey">No activity yet.</li>
            {% endfor %}
          </ul>
        </div>
      </div>

    </div>
  </div>
</section>

{# 6. NO ACTIVE CHALLENGE #}
{% else %}
<section class="section">
  <div class="container is-max-desktop has-text-centered">
    <h1 class="title">ğŸš« No active challenge</h1>
    <p class="subtitle">
      Thereâ€™s no step challenge running right now.
    </p>

    <a href="{% url 'steps-leaderboard' %}" class="button is-link is-light">
      View past challenges
    </a>
  </div>
</section>
{% endif %}

{% endblock %}
